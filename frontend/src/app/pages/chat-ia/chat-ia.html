<div class="app-container">
  <!-- Header ahora con el logo Y el botÃ³n hamburguesa -->
  <header class="header">
    <div class="header-logo">
      <img src="assets/logo.png" alt="Logo" class="logo-img">
      <h2>Nutrichef IA</h2>
    </div>
    
    <!-- BotÃ³n Hamburguesa para Mobile - AHORA EN EL HEADER -->
    <button class="menu-mobile-toggle" (click)="toggleMobileMenu()" [class.active]="isMobileMenuOpen">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>

    <div class="header-actions">
      <button *ngIf="recetaSeleccionada" (click)="volverAlChat()" class="back-btn">
        â† Volver al chat
      </button>
    </div>
  </header>

  <div class="content-wrapper">
    <!-- Sidebar para Desktop - SIN el botÃ³n hamburguesa -->
    <aside class="sidebar">
      <!-- EL BOTÃ“N HAMBURGUESA FUE MOVIDO AL HEADER -->

      <nav class="menu">
        <button class="menu-btn" routerLink="/principal">ğŸ  Inicio</button>
        <button class="menu-btn" routerLink="/recetas">ğŸ“– Recetas</button>
        <button class="menu-btn active">ğŸ’¬ Chat IA</button>
        <button class="menu-btn" routerLink="/analisis-imagen">ğŸ“¸ Analizar Imagen</button>
  
        
        <div class="historial">
          <h4>Historial de Recetas</h4>
        
          <button *ngFor="let item of historialRecetas" class="historial-btn" (click)="onCargarRecetaDelHistorial(item)">
        
            <div class="historial-item">
              <img class="historial-thumb" [src]="getImagenRecetaSafe(item.receta) || 'assets/placeholder-recipe.jpg'"
                alt="Miniatura de {{ item.receta?.nombre || ('Receta ' + item.id_receta) }}" />
        
              <span class="historial-title">
                {{ item.receta?.nombre || ('Receta ' + item.id_receta) }}
              </span>
        
              <!--
                Si mÃ¡s adelante quieres que la X elimine del historial:
                - Agregamos (click)="onEliminarDelHistorial(item, $event)"
                - Implementamos el mÃ©todo en el .ts
                De momento lo dejo sin (click) para que NO te dÃ© el error de
                "onEliminarDelHistorial no existe".
              -->
              <span class="historial-delete" (click)="onEliminarDelHistorial(item, $event)">
                âœ•
              </span>
            </div>
          </button>
        
          <div *ngIf="historialRecetas.length === 0" class="no-historial">
            <p>No hay recetas guardadas</p>
          </div>
        </div>
      </nav>

      <!-- User info del sidebar con botÃ³n de perfil -->
      <div class="user-info">
        <img src="assets/user.png" alt="Usuario" class="avatar">
        <div class="user-details">
          <p class="username">{{ userName || 'Usuario' }}</p>
          <p class="user-handle">{{ userEmail || '@usuario' }}</p>
        </div>
        <!-- BOTÃ“N DE PERFIL AÃ‘ADIDO -->
        <button class="profile-btn" routerLink="/perfil" title="Editar perfil">
          <img src="https://cdn-icons-png.flaticon.com/512/1828/1828911.png" alt="Editar perfil" class="pencil-icon">
        </button>
      </div>
    </aside>

    <!-- Overlay para cerrar menÃº mÃ³vil -->
    <div class="menu-overlay" 
         [class.active]="isMobileMenuOpen" 
         (click)="closeMobileMenu()">
    </div>

    <!-- MenÃº MÃ³vil Expandido -->
    <div class="menu-mobile-expanded" [class.active]="isMobileMenuOpen">
      <div class="menu-mobile-content">

        <!-- NavegaciÃ³n mÃ³vil -->
        <nav class="mobile-nav">
          <button class="menu-btn" 
                  routerLink="/principal" 
                  (click)="closeMobileMenu()">
            ğŸ  Inicio
          </button>
          <button class="menu-btn" 
                  routerLink="/recetas" 
                  (click)="closeMobileMenu()">
            ğŸ“– Recetas
          </button>
          <button class="menu-btn active" 
                  (click)="closeMobileMenu()">
            ğŸ’¬ Chat IA
          </button>
          <button class="menu-btn" 
                  routerLink="/analisis-imagen" 
                  (click)="closeMobileMenu()">
            ğŸ“¸ Analizar Imagen
          </button>
        </nav>

        <!-- Historial en versiÃ³n mÃ³vil -->
        <div class="mobile-historial">
          <h4>Historial de Recetas</h4>
          <div class="historial-list">
            <button *ngFor="let item of historialRecetas" class="historial-btn"
              (click)="onCargarRecetaDelHistorial(item); closeMobileMenu()">
        
              <div class="historial-item">
                <img class="historial-thumb" [src]="getImagenRecetaSafe(item.receta) || 'assets/placeholder-recipe.jpg'"
                  alt="Miniatura de {{ item.receta?.nombre || ('Receta ' + item.id_receta) }}" />
        
                <span class="historial-title">
                  {{ item.receta?.nombre || ('Receta ' + item.id_receta) }}
                </span>
        
                <span class="historial-delete" (click)="onEliminarDelHistorial(item, $event)">
                  âœ•
                </span>
              </div>
            </button>
        
            <div *ngIf="historialRecetas.length === 0" class="no-historial">
              <p>No hay recetas guardadas</p>
            </div>
          </div>
        </div>


        <!-- User info en mÃ³vil con botÃ³n de perfil -->
        <div class="mobile-user-info">
          <img src="assets/user.png" alt="Usuario" class="avatar">
          <div class="user-details">
            <p class="username">{{ userName || 'Usuario' }}</p>
            <p class="user-handle">{{ userEmail || '@usuario' }}</p>
          </div>
          <!-- BOTÃ“N DE PERFIL AÃ‘ADIDO EN MÃ“VIL -->
          <button class="profile-btn" routerLink="/perfil" (click)="closeMobileMenu()" title="Editar perfil">
            <img src="https://cdn-icons-png.flaticon.com/512/1828/1828911.png" alt="Editar perfil" class="pencil-icon">
          </button>
        </div>
      </div>
    </div>

    <!-- Main content sin el header -->
    <main class="main-content">
      <!-- Chat Container -->
      <div class="chat-container">
        <!-- MODO RECETA COMPLETA -->
        <div *ngIf="recetaSeleccionada" class="recipe-full-view">
          <div class="recipe-full-card">
            <!-- Header -->
            <div class="recipe-full-header">
              <h2 class="recipe-full-title">{{ recetaSeleccionada.titulo }}</h2>
              <div class="recipe-full-meta">
                <span class="meta-badge">{{ recetaSeleccionada.categoria }}</span>
                <span class="meta-badge">â± {{ recetaSeleccionada.tiempo_preparacion }} min</span>
                <span class="meta-badge">ğŸ”¥ {{ recetaSeleccionada.kcal_totales }} kcal</span>
              </div>
            </div>
            
            <img *ngIf="recetaSeleccionada?.imagen_url" [src]="recetaSeleccionada.imagen_url || 'assets/placeholder-recipe.jpg'"
            alt="Imagen de {{ recetaSeleccionada.titulo }}" class="recipe-image" />

            <!-- DescripciÃ³n -->
            <div class="recipe-full-description">
              <p>{{ recetaSeleccionada.descripcion }}</p>
            </div>

            <!-- Ingredientes -->
            <div class="recipe-full-section">
              <h3>ğŸ´ Ingredientes</h3>
              <div class="ingredients-grid-full">
                <div *ngFor="let ing of recetaSeleccionada.ingredientes" class="ingredient-full">
                  <span class="ingredient-name">{{ ing.nombre }}</span>
                  <span *ngIf="ing.cantidad" class="ingredient-quantity">
                    {{ ing.cantidad }} {{ ing.unidad || 'unidades' }}
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Lista de compras / ingredientes detallados -->
            <div class="recipe-full-section shopping-list-section">
              <div class="shopping-list-header">
                <h3>ğŸ›’ Lista de ingredientes</h3>
                <button class="shopping-list-btn" (click)="verListaIngredientesSeleccionada()">
                  Ver lista detallada
                </button>
              </div>
            
              <!-- Cuando ya cargamos la lista -->
              <div *ngIf="shoppingList.length > 0" class="shopping-list-content">
                <ul class="shopping-list">
                  <li *ngFor="let item of shoppingList" class="shopping-list-item">
                    <strong>{{ item.nombre }}</strong>
                    <ul class="shopping-list-detalles" *ngIf="item.detalles && item.detalles.length > 0">
                      <li *ngFor="let d of item.detalles">
                        {{ d }}
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            
              <!-- Si la lista vino vacÃ­a (receta sin ingredientes_detalles) -->
              <p *ngIf="!shoppingList.length" class="shopping-list-empty-hint">
                Haz clic en "Ver lista detallada" para generar la lista de ingredientes de esta receta.
              </p>
            </div>

            <!-- PreparaciÃ³n -->
            <div class="recipe-full-section">
              <h3>ğŸ‘©â€ğŸ³ PreparaciÃ³n</h3>
              <ol class="steps-full">
                <li *ngFor="let paso of recetaSeleccionada.pasos" class="step-full">
                  {{ paso }}
                </li>
              </ol>
            </div>

            <!-- ExplicaciÃ³n IA -->
            <div *ngIf="recetaSeleccionada.ia_explicacion" class="ia-full">
              <h3>ğŸ¤– Por quÃ© esta receta es para ti</h3>
              <div class="ia-full-content">
                {{ recetaSeleccionada.ia_explicacion }}
              </div>
            </div>
          </div>
        </div>

        <!-- MODO CHAT NORMAL (cuando no hay receta seleccionada) -->
        <div *ngIf="!recetaSeleccionada">
          
          <!-- VISTA INICIAL - Solo cuando no hay conversaciÃ³n -->
          <div *ngIf="conversationHistory.length === 0" class="initial-view">
            <!-- SecciÃ³n de entrada del usuario -->
            <div class="input-section">
              <h2>Â¿QuÃ© te gustarÃ­a cocinar?</h2>
              <div class="input-container">
                <input 
                  type="text" 
                  [(ngModel)]="userMessage" 
                  placeholder="Escribe tus preferencias aquÃ­..."
                  class="message-input"
                  (keyup.enter)="sendMessage()">
                <button (click)="sendMessageWithValidation()" class="send-btn">Enviar</button>
              </div>
              <!-- NUEVO: SecciÃ³n de sugerencias agregada -->
              <div class="suggestions-section">
                <p class="suggestions-label">Â¿Quieres algo adaptado a tu perfil?: </p>
                <button (click)="sendMessage()" class="suggestion-btn">
                  Generar recomendaciones
                </button>
              </div>
            </div>
            
            <!-- Loading general (para la vista inicial) -->
            <div *ngIf="cargando" class="loading-section">
              <div class="spinner"></div>
              <p>Generando recomendaciones personalizadas...</p>
            </div>
          </div>

          <!-- VISTA CHAT - Cuando ya hay conversaciÃ³n -->
          <div *ngIf="conversationHistory.length > 0" class="chat-view">
            
            <!-- HISTORIAL COMPLETO DE LA CONVERSACIÃ“N -->
            <div class="conversation-history-container">
              
              <!-- Mostrar todos los mensajes de la conversaciÃ³n -->
              <div *ngFor="let message of conversationHistory; let i = index" 
                   class="conversation-message"
                   [class.user-message]="message.type === 'user'"
                   [class.assistant-message]="message.type === 'assistant'">
                
                <!-- Mensaje del usuario -->
                <div *ngIf="message.type === 'user'" class="message-bubble user-bubble">
                  <div class="message-avatar">ğŸ‘¤</div>
                  <div class="message-content">
                    
                    <!-- Modo visualizaciÃ³n normal - MOSTRAR cuando NO estamos editando este mensaje -->
                    <div *ngIf="editingMessageIndex !== i" class="message-display">
                      <div class="message-text">{{ message.content }}</div>
                      <div class="message-actions">
                        <button class="edit-btn" (click)="startEditMessage(i)" title="Editar mensaje">
                          âœ
                        </button>
                      </div>
                      <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
                    </div>
                    
                    <!-- Modo ediciÃ³n inline - MOSTRAR cuando SÃ estamos editando este mensaje -->
                    <div *ngIf="editingMessageIndex === i" class="message-edit">
                      <div class="edit-input-container">
                        <input 
                          type="text" 
                          [(ngModel)]="editingMessageText"
                          class="edit-message-input"
                          placeholder="Edita tu mensaje..."
                          (keyup.enter)="saveEditedMessage()"
                          (keyup.escape)="cancelEdit()"
                          #editInput>
                        <div class="edit-actions">
                          <button class="edit-cancel-btn" (click)="cancelEdit()" title="Cancelar">
                            âŒ
                          </button>
                          <button class="edit-save-btn" (click)="saveEditedMessage()" title="Guardar">
                            âœ…
                          </button>
                        </div>
                      </div>
                      <div class="edit-hint">
                        Presiona Enter para guardar, Esc para cancelar
                      </div>
                    </div>
                    
                  </div>
                </div>

                <!-- Mensaje de la IA con recetas -->
                <div *ngIf="message.type === 'assistant'" class="message-bubble assistant-bubble">
                  <div class="message-avatar">ğŸ¤–</div>
                  <div class="message-content">
                    <div class="message-text">{{ message.content }}</div>
                    
                    <!-- Recetas en el mensaje de la IA -->
                    <div *ngIf="message.recipes && message.recipes.length > 0" class="recipes-in-message">
                      
                      <div *ngFor="let receta of message.recipes" class="message-recipe-card">
                        <img *ngIf="receta?.imagen_url" [src]="receta.imagen_url || 'assets/placeholder-recipe.jpg'"
                        alt="Imagen de {{ receta.titulo }}" class="message-recipe-image" />

                        <h4 class="recipe-message-title">{{ receta.titulo }}</h4>
                        <p class="recipe-message-desc">{{ receta.descripcion }}</p>
                        
                        <!-- Ingredientes -->
                        <div class="recipe-message-ingredients">
                          <strong>Ingredientes:</strong>
                          <span *ngFor="let ing of receta.ingredientes; let i = index">
                            <span *ngIf="i > 0">â€¢ </span>
                            <ng-container *ngIf="ing?.nombre; else plainIng">
                              {{ ing.nombre }}
                              <span *ngIf="ing.cantidad">({{ ing.cantidad }} {{ ing.unidad || 'un' }})</span>
                            </ng-container>
                            <ng-template #plainIng>{{ ing }}</ng-template>
                          </span>
                        </div>

                        <!-- PreparaciÃ³n -->
                        <div class="recipe-message-preparation">
                          <strong>PreparaciÃ³n:</strong>
                          <ol class="recipe-message-steps">
                            <li *ngFor="let paso of receta.pasos">{{ paso }}</li>
                          </ol>
                        </div>

                        <!-- ExplicaciÃ³n IA -->
                        <div *ngIf="receta.ia_explicacion" class="recipe-message-ia">
                          {{ receta.ia_explicacion }}
                        </div>

                        <!-- BotÃ³n para seleccionar -->
                        <button class="recipe-message-choose-btn"
                                (click)="onSeleccionarReceta(receta)">
                          Prefiero esta respuesta
                        </button>
                      </div>
                    </div>
                    
                    <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
                  </div>
                </div>
              </div>

              <!-- Loading en la conversaciÃ³n -->
              <div *ngIf="cargando" class="message-bubble assistant-bubble loading-message">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                  <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
              </div>

            </div>

            <!-- INPUT PARA CHAT - Solo se muestra cuando hay conversaciÃ³n -->
            <div class="input-section chat-input-bottom-chat">
              <div class="input-container">
                <input 
                  type="text" 
                  [(ngModel)]="userMessage" 
                  placeholder="Escribe tu mensaje aquÃ­..."
                  class="message-input"
                  (keyup.enter)="sendMessage()">
                <button (click)="sendMessage()" class="send-btn">Enviar</button>
              </div>
            </div>
          </div>

          <!-- Error -->
          <div *ngIf="errorMessage" class="error-message">
            <p>âŒ {{ errorMessage }}</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>