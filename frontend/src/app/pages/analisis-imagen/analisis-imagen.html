<div class="app-container">
  <!-- Header principal -->
  <header class="main-header">
    <div class="header-left">
      <img src="assets/logo.png" alt="Logo" class="header-logo">
      <h1 class="header-title">Nutrichef IA</h1>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav class="menu">
      <button class="menu-btn" type="button" routerLink="/principal" routerLinkActive="active">ğŸ  Inicio</button>
      <button class="menu-btn" type="button" routerLink="/recetas" routerLinkActive="active">ğŸ“– Recetas</button>
      <button class="menu-btn" type="button" routerLink="/chat-ia" routerLinkActive="active">ğŸ’¬ Chat IA</button>
      <button class="menu-btn" type="button" routerLink="/analizar" routerLinkActive="active">ğŸ“¸ Analizar imagen</button>

      <!-- Historial dinÃ¡mico -->
      <div class="historial">
        <h3 class="historial-title">Historial de recetas</h3>

        <div *ngIf="historialSidebar.length === 0" class="historial-vacio">
          <p>No hay anÃ¡lisis aÃºn</p>
        </div>

        <button
          *ngFor="let item of historialSidebar"
          class="historial-btn"
          (click)="cargarAnalisisDesdeHistorial(item.id_plato)"
          [title]="item.nombre">
          <div class="historial-item-content">
            <img [src]="item.imagen_url" alt="Vista previa" class="historial-thumbnail"
                 onerror="this.src='assets/default-food.jpg'">
            <div class="historial-info">
              <span class="historial-nombre">{{ item.nombre }}</span>
              <span class="historial-fecha">{{ formatearFecha(item.fecha) }}</span>
            </div>
            <button
              class="historial-delete"
              (click)="eliminarDelHistorial(item.id_plato, $event)"
              title="Eliminar">Ã—</button>
          </div>
        </button>
      </div>
    </nav>

    <div class="user-info">
      <!-- ACTUALIZADO: Usar foto del usuario dinÃ¡micamente -->
      <img [src]="userAvatar" alt="Usuario" class="avatar">
      <div class="user-details">
        <p class="username">{{ userName || 'Usuario' }}</p>
        <p class="user-handle">{{ userEmail || authService.currentUserEmail || '@usuario' }}</p>
      </div>
      <!-- BOTÃ“N DE PERFIL AÃ‘ADIDO -->
      <button class="profile-btn" routerLink="/perfil" title="Editar perfil">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828911.png" alt="Editar perfil" class="pencil-icon">
      </button>
    </div>
  </aside>

  <!-- Contenido principal -->
  <main class="main-content">
    <div class="analisis-imagen-container"
         (dragover)="onDragOver($event)"
         (dragleave)="onDragLeave($event)"
         (drop)="onDrop($event)">

      <div class="upload-section" *ngIf="!imageUrl && !analysisResult">
        <h2>Sube o toma una imagen para analizar ğŸ½ï¸</h2>

        <!-- Botones universales -->
        <div class="upload-buttons">
          <label class="upload-btn">
            Subir imagen
            <input type="file" accept="image/*" (change)="onFileSelected($event)">
          </label>
          
          <button class="upload-btn camera-btn" (click)="openCamera()" type="button">
            Tomar foto
          </button>
        </div>

        <p class="hint">
          Sube una imagen de tu galerÃ­a o toma una foto con la cÃ¡mara.
        </p>
        
        <p class="camera-status" *ngIf="!hasCameraSupport">
          âš ï¸ No se detectÃ³ cÃ¡mara disponible en este dispositivo
        </p>
      </div>

      <!-- Vista previa -->
      <div *ngIf="imageUrl && !analysisResult" class="image-preview">
        <img [src]="imageUrl" alt="Imagen de comida">
        <button class="analyze-btn" (click)="uploadImage()">Analizar imagen</button>
        <button class="new-analysis-btn" (click)="resetAnalysis()">Elegir otra imagen</button>
      </div>

      <!-- Loading -->
      <div *ngIf="analysisResult === 'Analizando imagen...'" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Analizando tu imagen...</p>
      </div>

      <!-- Resultados -->
      <div *ngIf="analysisResult && analysisResult !== 'Analizando imagen...'" class="analysis-results">
        <div class="natural-analysis" [class.non-food-warning]="isNonFoodMessage">
          <app-food-dashboard *ngIf="dashboardData && dashboardData.items && dashboardData.items.length > 0 && !isNonFoodMessage" 
                              [data]="dashboardData" 
                              [imageUrl]="imageUrl"
                              [rawAnalysis]="narrativeAnalysis"></app-food-dashboard>
      <div *ngIf="(!dashboardData || !dashboardData.items || dashboardData.items.length === 0) || isNonFoodMessage" 
           class="natural-text ai-raw" 
           [innerHTML]="analysisResult | aiTextToHtml"></div>
        </div>

        <button class="new-analysis-btn" (click)="resetAnalysis()">
          {{ isNonFoodMessage ? 'ğŸ“· Subir imagen de comida' : 'Analizar nueva imagen' }}
        </button>
      </div>

      <!-- Error -->
      <div *ngIf="errorMessage" class="error-message">
        <p>Error: {{ errorMessage }}</p>
        <button class="new-analysis-btn" (click)="resetAnalysis()">Intentar de nuevo</button>
      </div>
    </div>
  </main>
</div>